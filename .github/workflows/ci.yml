name: CI

on:
  pull_request:
    branches: [dev]

jobs:
  ci:
    runs-on: ubuntu-latest
    outputs:
      client-changed: ${{ steps.filter.outputs.client }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for client changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            client:
              - 'apps/client/**'
              - 'packages/common/**'
              - 'pnpm-lock.yaml'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Build common package
        run: pnpm --filter @codejam/common build

      - name: Format check
        id: format
        continue-on-error: true
        run: pnpm format:check

      - name: Lint
        id: lint
        continue-on-error: true
        run: pnpm lint

      - name: Type check
        id: typecheck
        continue-on-error: true
        run: pnpm check-types

      - name: Test
        id: test
        continue-on-error: true
        run: pnpm test

      - name: Build
        id: build
        continue-on-error: true
        run: pnpm build

      - name: PR Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const formatResult = '${{ steps.format.outcome }}';
            const lintResult = '${{ steps.lint.outcome }}';
            const typecheckResult = '${{ steps.typecheck.outcome }}';
            const testResult = '${{ steps.test.outcome }}';
            const buildResult = '${{ steps.build.outcome }}';

            const getEmoji = (result) => result === 'success' ? 'âœ…' : 'âŒ';
            const allPassed = [formatResult, lintResult, typecheckResult, testResult, buildResult].every(r => r === 'success');

            const body = `## CI ê²°ê³¼ ${allPassed ? 'âœ…' : 'âŒ'}

            | ê²€ì‚¬ í•­ëª© | ê²°ê³¼ |
            |----------|------|
            | Format | ${getEmoji(formatResult)} ${formatResult} |
            | Lint | ${getEmoji(lintResult)} ${lintResult} |
            | Type Check | ${getEmoji(typecheckResult)} ${typecheckResult} |
            | Test | ${getEmoji(testResult)} ${testResult} |
            | Build | ${getEmoji(buildResult)} ${buildResult} |

            ${allPassed ? 'ğŸ‰ ëª¨ë“  ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤!' : 'âš ï¸ ì¼ë¶€ ê²€ì‚¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'}
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('## CI ê²°ê³¼')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if any check failed
        if: steps.format.outcome == 'failure' || steps.lint.outcome == 'failure' || steps.typecheck.outcome == 'failure' || steps.build.outcome == 'failure'
        run: exit 1

  cli-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check CLI
        run: pnpm --filter @codejam/cli check-types

      - name: Build CLI
        run: pnpm --filter @codejam/cli build

      - name: Test CLI binary
        run: |
          cd packages/cli
          node dist/index.js --version
          node dist/index.js --help

  vercel-preview:
    needs: ci
    if: needs.ci.outputs.client-changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Setup Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies and build common
        run: |
          pnpm install --frozen-lockfile
          pnpm --filter @codejam/common build

      - name: Install Vercel CLI
        run: pnpm add -g vercel

      - name: Build client for Vercel
        run: |
          cd apps/client
          mkdir -p .vercel
          cat > .vercel/project.json <<'EOF'
          {
            "projectId": "${{ secrets.VERCEL_PROJECT_ID }}",
            "orgId": "${{ secrets.VERCEL_ORG_ID }}",
            "projectName": "codejam"
          }
          EOF
          vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
          vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Remove Previous Preview Deployment
        id: remove-previous
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('## ğŸ¯ ìƒˆë¡œìš´ ì¼ì´ ì™„ì„±ëì–´ìš”!')
            );

            if (botComment) {
              const urlMatch = botComment.body.match(/Preview URL \| \[([^\]]+)\]/);
              if (urlMatch) {
                core.setOutput('previous-url', urlMatch[1]);
              }
            }

      - name: Delete Previous Deployment
        if: steps.remove-previous.outputs.previous-url
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "Removing previous deployment: ${{ steps.remove-previous.outputs.previous-url }}"
          vercel remove "${{ steps.remove-previous.outputs.previous-url }}" --token=$VERCEL_TOKEN --yes || true

      - name: Deploy to Vercel Preview
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./apps/client
          vercel-args: '--prebuilt'

      - name: Comment PR with Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const deployUrl = '${{ steps.deploy.outputs.preview-url }}';

            const body = `## ğŸ¯ ìƒˆë¡œìš´ ì¼ì´ ì™„ì„±ëì–´ìš”!
            | í•­ëª© | ë‚´ìš© |
            |------|------|
            | Preview URL | [${deployUrl}](${deployUrl}) |
            | Commit | \`${{ github.event.pull_request.head.sha }}\` |
            | Branch | \`${{ github.head_ref }}\` |
            | ì‘ì„±ì | @${{ github.actor }} |

            > ì´ ë°°í¬ëŠ” client ì½”ë“œ ë³€ê²½ì´ ê°ì§€ë˜ì–´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('## ğŸ¯ ìƒˆë¡œìš´ ì¼ì´ ì™„ì„±ëì–´ìš”!')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
