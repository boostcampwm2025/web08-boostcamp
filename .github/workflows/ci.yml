name: CI

on:
  pull_request:
    branches: [develop]

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build common package
        run: pnpm --filter @codejam/common build

      - name: Format check
        id: format
        continue-on-error: true
        run: pnpm format:check

      - name: Lint
        id: lint
        continue-on-error: true
        run: pnpm lint

      - name: Type check
        id: typecheck
        continue-on-error: true
        run: pnpm check-types

      - name: Test
        id: test
        continue-on-error: true
        run: pnpm test

      - name: Build
        id: build
        continue-on-error: true
        run: pnpm build

      - name: PR Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const formatResult = '${{ steps.format.outcome }}';
            const lintResult = '${{ steps.lint.outcome }}';
            const typecheckResult = '${{ steps.typecheck.outcome }}';
            const testResult = '${{ steps.test.outcome }}';
            const buildResult = '${{ steps.build.outcome }}';

            const getEmoji = (result) => result === 'success' ? 'âœ…' : 'âŒ';
            const allPassed = [formatResult, lintResult, typecheckResult, testResult, buildResult].every(r => r === 'success');

            const body = `## CI ê²°ê³¼ ${allPassed ? 'âœ…' : 'âŒ'}

            | ê²€ì‚¬ í•­ëª© | ê²°ê³¼ |
            |----------|------|
            | Format | ${getEmoji(formatResult)} ${formatResult} |
            | Lint | ${getEmoji(lintResult)} ${lintResult} |
            | Type Check | ${getEmoji(typecheckResult)} ${typecheckResult} |
            | Test | ${getEmoji(testResult)} ${testResult} |
            | Build | ${getEmoji(buildResult)} ${buildResult} |

            ${allPassed ? 'ðŸŽ‰ ëª¨ë“  ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤!' : 'âš ï¸ ì¼ë¶€ ê²€ì‚¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'}
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('## CI ê²°ê³¼')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if any check failed
        if: steps.format.outcome == 'failure' || steps.lint.outcome == 'failure' || steps.typecheck.outcome == 'failure' || steps.build.outcome == 'failure'
        run: exit 1
