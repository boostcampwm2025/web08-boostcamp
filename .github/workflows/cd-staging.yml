name: CD Staging

on:
  push:
    branches: [dev]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check changed files
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            client:
              - 'apps/client/**'
              - 'packages/common/**'
              - 'pnpm-lock.yaml'
            server:
              - 'apps/server/**'
              - 'packages/common/**'
              - 'pnpm-lock.yaml'

      - name: Setup pnpm
        if: steps.changes.outputs.client == 'true' || steps.changes.outputs.server == 'true'
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        if: steps.changes.outputs.client == 'true' || steps.changes.outputs.server == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        if: steps.changes.outputs.client == 'true' || steps.changes.outputs.server == 'true'
        run: pnpm install --frozen-lockfile

      - name: Build client and dependencies
        if: steps.changes.outputs.client == 'true'
        run: pnpm --filter client... build

      - name: Deploy to Vercel (Staging)
        if: steps.changes.outputs.client == 'true'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./apps/client

      - name: Build server and dependencies
        if: steps.changes.outputs.server == 'true'
        run: pnpm --filter server... build

      - name: Set up Docker Buildx
        if: steps.changes.outputs.server == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to NCP Container Registry
        if: steps.changes.outputs.server == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.NCP_REGISTRY_URL }}
          username: ${{ secrets.NCP_ACCESS_KEY }}
          password: ${{ secrets.NCP_SECRET_KEY }}

      - name: Build and push Docker image
        if: steps.changes.outputs.server == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/server/Dockerfile
          push: true
          tags: |
            ${{ secrets.NCP_REGISTRY_URL }}/server:${{ github.sha }}
            ${{ secrets.NCP_REGISTRY_URL }}/server:latest
          cache-from: type=registry,ref=${{ secrets.NCP_REGISTRY_URL }}/server:latest
          cache-to: type=inline

      - name: Deploy to NCP
        if: steps.changes.outputs.server == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.NCP_HOST }}
          username: ${{ secrets.NCP_USERNAME }}
          key: ${{ secrets.NCP_SSH_KEY }}
          port: ${{ secrets.NCP_PORT }}
          script: |
            docker login -u ${{ secrets.NCP_ACCESS_KEY }} -p ${{ secrets.NCP_SECRET_KEY }} ${{ secrets.NCP_REGISTRY_URL }}
            docker pull ${{ secrets.NCP_REGISTRY_URL }}/server:${{ github.sha }}
            docker stop server-staging || true
            docker rm server-staging || true
            docker run -d \
              --name server-staging \
              --restart unless-stopped \
              -p 3001:3000 \
              --env-file /root/.env.prod \
              ${{ secrets.NCP_REGISTRY_URL }}/server:${{ github.sha }}
            docker image prune -af --filter "until=24h"
